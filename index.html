<script>
window.onload = function () {
  const width = window.innerWidth;
  const height = window.innerHeight;
  const canvas = document.querySelector('canvas');
  canvas.width = width;
  canvas.height = height;
  const c = canvas.getContext('2d');

  const naveImg = new Image();
  naveImg.src = 'imagens/Spaceship-PNG-File.png';
  const rochaImg = new Image();
  rochaImg.src = 'imagens/stone_PNG13556.png';

  const atualizarPontuacao = (pontos) =>
    (document.getElementById("pontuacao").innerText = `Pontos: ${pontos}`);

  const iniciarJogo = () => {
    document.getElementById("tela-inicial").style.display = "none";
    document.getElementById("tela-game-over").style.display = "none";
    canvas.style.display = "block";
    document.getElementById("pontuacao").style.display = "block";

    estadoGlobal.valor = {
      nave: { x: width / 2 - 50, y: height - 100 },
      rochas: criarRochas(),
      tiros: [],
      pontos: 0,
      ativo: true
    };

    atualizarPontuacao(0);
    animate();
  };

  const mostrarGameOver = () => {
    document.getElementById("tela-game-over").style.display = "flex";
    canvas.style.display = "none";
    document.getElementById("pontuacao").style.display = "none";
  };

  const atirar = (estado) => {
    estadoGlobal.valor = {
      ...estado,
      tiros: [
        ...estado.tiros,
        {
          x: estado.nave.x + 45,
          y: estado.nave.y - 20,
          width: 10,
          height: 20,
          speed: 5
        }
      ]
    };
  };

  const animate = () => {
    const estado = estadoGlobal.valor;
    if (!estado.ativo) return;

    requestAnimationFrame(animate);
    c.fillStyle = "black";
    c.fillRect(0, 0, width, height);

    c.drawImage(naveImg, estado.nave.x, estado.nave.y, 100, 100);

    const novasRochas = estado.rochas.map((rocha) => {
      const novaY = rocha.y + 2;
      return novaY > height
        ? { x: Math.random() * (width - 50), y: 0 }
        : { ...rocha, y: novaY };
    });

    const novosTiros = estado.tiros
      .map((tiro) => ({ ...tiro, y: tiro.y - tiro.speed }))
      .filter((tiro) => tiro.y > 0);

    const { tirosAtualizados, rochasAtualizadas, pontosGanho } = verificarColisoes(novosTiros, novasRochas);

    const naveColidiu = rochasAtualizadas.some((rocha) =>
      checkCollision(estado.nave, rocha)
    );

    if (naveColidiu) {
      mostrarGameOver();
      estadoGlobal.valor = { ...estado, ativo: false };
      return;
    }

    const novoPontoTotal = estado.pontos + pontosGanho;
    atualizarPontuacao(novoPontoTotal);

    estadoGlobal.valor = {
      ...estado,
      rochas: rochasAtualizadas,
      tiros: tirosAtualizados,
      pontos: novoPontoTotal
    };

    rochasAtualizadas.forEach((rocha) =>
      c.drawImage(rochaImg, rocha.x, rocha.y, 50, 50)
    );

    c.fillStyle = 'red';
    tirosAtualizados.forEach((tiro) =>
      c.fillRect(tiro.x, tiro.y, tiro.width, tiro.height)
    );
  };

  const checkCollision = (rect1, rect2) =>
    rect1.x < rect2.x + 50 &&
    rect1.x + 100 > rect2.x &&
    rect1.y < rect2.y + 50 &&
    rect1.y + 100 > rect2.y;

  const criarRochas = () =>
    Array.from({ length: 5 }, () => ({
      x: Math.random() * (width - 50),
      y: 0
    }));

  const estadoGlobal = { valor: null };

  const verificarColisoes = (tiros, rochas) =>
    tiros.reduce(
      ({ tirosAtualizados, rochasAtualizadas, pontosGanho }, tiro) => {
        const colisaoIndex = rochasAtualizadas.findIndex((rocha) =>
          checkCollision(tiro, rocha)
        );
        if (colisaoIndex !== -1) {
          const novaRocha = {
            x: Math.random() * (width - 50),
            y: 0
          };
          return {
            tirosAtualizados,
            rochasAtualizadas: rochasAtualizadas.map((r, i) =>
              i === colisaoIndex ? novaRocha : r
            ),
            pontosGanho: pontosGanho + 10
          };
        }
        return {
          tirosAtualizados: [...tirosAtualizados, tiro],
          rochasAtualizadas,
          pontosGanho
        };
      },
      { tirosAtualizados: [], rochasAtualizadas: rochas, pontosGanho: 0 }
    );

  const moverNave = (estado, direcao) => {
    const novoX =
      direcao === "direita"
        ? Math.min(estado.nave.x + 40, width - 100)
        : Math.max(estado.nave.x - 40, 0);
    estadoGlobal.valor = { ...estado, nave: { ...estado.nave, x: novoX } };
  };

  window.addEventListener("keydown", function (e) {
    const estado = estadoGlobal.valor;
    if (!estado || !estado.ativo) return;

    if (e.key === "ArrowRight") moverNave(estado, "direita");
    if (e.key === "ArrowLeft") moverNave(estado, "esquerda");
    if (e.key === " " || e.key === "Spacebar") atirar(estado);
  });

  document.getElementById("start-btn").addEventListener("click", iniciarJogo);
  document.getElementById("restart-btn").addEventListener("click", iniciarJogo);
};
</script>
