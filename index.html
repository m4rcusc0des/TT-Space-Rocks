<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TT Space Rocks</title>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    body {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background: black;
    }
    #pontuacao {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 24px;
      font-family: Arial, sans-serif;
      display: none;
    }
    #tela-inicial, #tela-game-over {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.9);
    }
    #tela-game-over {
      display: none;
    }
    canvas {
      display: none;
    }
    .btn {
      width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:hover {
      transform: scale(1.1);
    }
    #instrucoes {
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 20px;
      max-width: 80%;
    }
    #instrucoes p {
      margin: 8px 0;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="pontuacao">Pontos: 0</div>

  <div id="tela-inicial">
    <img src="imagens/titulo.png" alt="Título do jogo"/>
    <img id="start-btn" class="btn" src="imagens/botao.png" alt="Botão Iniciar"/>
    
    <div id="instrucoes">
      <p>Use as setas ⬅ ➡ para mover a nave.</p>
      <p>Pressione <strong>Espaço</strong> para atirar.</p>
      <p>Desvie das rochas e destrua o máximo que puder!</p>
    </div>
  </div>

  <div id="tela-game-over">
    <img src="https://via.placeholder.com/400x100/FF0000/FFFFFF?text=Game+Over" alt="Game Over"/>
    <img id="restart-btn" class="btn" src="https://via.placeholder.com/200x80/00FF00/FFFFFF?text=Restart" alt="Botão Reiniciar"/>
  </div>

  <canvas></canvas>

  <script>
    // Configurações iniciais
    const width = window.innerWidth;
    const height = window.innerHeight;
    const canvas = document.querySelector('canvas');
    canvas.width = width;
    canvas.height = height;
    const c = canvas.getContext('2d');

    // Carregamento de imagens
    const naveImg = new Image();
    naveImg.src = 'imagens/Spaceship-PNG-File.png';
    const rochaImg = new Image();
    rochaImg.src = 'imagens/stone_PNG13556.png';
    
    // Controle de carregamento
    let imagensCarregadas = false;
    let imagensParaCarregar = 2;
    
    function imagemCarregada() {
      imagensParaCarregar--;
      if (imagensParaCarregar === 0) {
        imagensCarregadas = true;
      }
    }
    
    naveImg.onload = imagemCarregada;
    rochaImg.onload = imagemCarregada;
    naveImg.onerror = () => console.error("Erro ao carregar imagem da nave");
    rochaImg.onerror = () => console.error("Erro ao carregar imagem da rocha");

    // Estado do jogo
    const estadoGlobal = { valor: null };
      
    const iniciarJogo = () => {
      if (!imagensCarregadas) {
        alert("Por favor, aguarde as imagens carregarem...");
        return;
      }
      
      document.getElementById("tela-inicial").style.display = "none";
      document.getElementById("tela-game-over").style.display = "none";
      canvas.style.display = "block";
      document.getElementById("pontuacao").style.display = "block";

      estadoGlobal.valor = {
        nave: { 
          x: width / 2 - 50, 
          y: height - 100, 
          width: 100, 
          height: 100 
        },
        rochas: criarRochas(),
        tiros: [],
        pontos: 0,
        ativo: true,
        velocidadeRochas: 2,
        velocidadeJogo: 1
      };

      atualizarPontuacao(0);
      if (!estadoGlobal.valor.animacaoAtiva) {
        estadoGlobal.valor.animacaoAtiva = true;
        animate();
      }
    };
    
    const mostrarGameOver = () => {
      document.getElementById("tela-game-over").style.display = "flex";
      canvas.style.display = "none";
      document.getElementById("pontuacao").style.display = "none";
      estadoGlobal.valor.animacaoAtiva = false;
    };
    
    const atirar = (estado) => {
      estadoGlobal.valor = {
        ...estado,// Copia tudo do estado (naves, rochas, tiros...) usando o conceito de imutabilidade
        tiros: [
          ...estado.tiros,// Sobrescreve tiros com o novo tiro (também usando imutabilidade)
          {
            x: estado.nave.x + 45,
            y: estado.nave.y - 20,
            width: 10,
            height: 20,
            speed: 10
          }
        ]
      };
    };

    const animate = () => {
      const estado = estadoGlobal.valor;//armazena os dados do jogo
      if (!estado || !estado.ativo) return;//para a função se o usuário perdeu

      requestAnimationFrame(animate);//se chama recursivamente
      c.clearRect(0, 0, width, height);
      c.fillStyle = "black";
      c.fillRect(0, 0, width, height);

      // Desenha a nave
      c.drawImage(naveImg, estado.nave.x, estado.nave.y, estado.nave.width, estado.nave.height);

      // Atualiza posição das rochas
      const novasRochas = estado.rochas.map((rocha) => {
        const novaY = rocha.y + estado.velocidadeRochas * estado.velocidadeJogo;
        return novaY > height
          ? { 
              x: Math.random() * (width - 50), 
              y: -100, 
              width: 50, 
              height: 50 
            }
          : { ...rocha, y: novaY };
      });

      // Atualiza posição dos tiros
      const novosTiros = estado.tiros
        .map((tiro) => ({ ...tiro, y: tiro.y - tiro.speed }))
        .filter((tiro) => tiro.y > 0);

      // Verifica colisões
      const { tirosAtualizados, rochasAtualizadas, pontosGanho } = 
        verificarColisoes(novosTiros, novasRochas);

      // Verifica colisão com a nave
      const naveColidiu = rochasAtualizadas.some((rocha) =>
        checkCollision(estado.nave, rocha)
      );

      if (naveColidiu) {
        mostrarGameOver();
        estadoGlobal.valor = { ...estado, ativo: false };
        return;
      }

      // Atualiza pontuação e dificuldade
      const novoPontoTotal = estado.pontos + pontosGanho;
      atualizarPontuacao(novoPontoTotal);
      
      // Aumenta a dificuldade conforme os pontos
      const novaVelocidadeJogo = 1 + Math.floor(novoPontoTotal / 500);
      const novaVelocidadeRochas = 2 + Math.floor(novoPontoTotal / 1000);

      estadoGlobal.valor = {
        ...estado,
        rochas: rochasAtualizadas,
        tiros: tirosAtualizados,
        pontos: novoPontoTotal,
        velocidadeJogo: novaVelocidadeJogo,
        velocidadeRochas: novaVelocidadeRochas
      };

      // Desenha as rochas
      rochasAtualizadas.forEach((rocha) =>
        c.drawImage(rochaImg, rocha.x, rocha.y, rocha.width, rocha.height)
      );

      // Desenha os tiros
      c.fillStyle = 'yellow';
      tirosAtualizados.forEach((tiro) =>
        c.fillRect(tiro.x, tiro.y, tiro.width, tiro.height)
      );
    };
    
    const checkCollision = (rect1, rect2) =>
      rect1.x < rect2.x + rect2.width &&
      rect1.x + rect1.width > rect2.x &&
      rect1.y < rect2.y + rect2.height &&
      rect1.y + rect1.height > rect2.y;

    const criarRochas = () =>
      Array.from({ length: 8 }, () => ({
        x: Math.random() * (width - 50),
        y: Math.random() * -500,
        width: 50,
        height: 50
      }));

    const verificarColisoes = (tiros, rochas) =>
      tiros.reduce(
        (acc, tiro) => {
          const colisaoIndex = acc.rochasAtualizadas.findIndex((rocha) =>
            checkCollision(tiro, rocha)
          );
          
          if (colisaoIndex !== -1) {
            return {
              tirosAtualizados: acc.tirosAtualizados,
              rochasAtualizadas: acc.rochasAtualizadas.map((r, i) =>
                i === colisaoIndex ? {
                  x: Math.random() * (width - 50),
                  y: -100,
                  width: 50,
                  height: 50
                } : r
              ),
              pontosGanho: acc.pontosGanho + 10
            };
          }
          return {
            ...acc,
            tirosAtualizados: [...acc.tirosAtualizados, tiro]
          };
        },
        { tirosAtualizados: [], rochasAtualizadas: rochas, pontosGanho: 0 }
      );

    const moverNave = (estado, direcao) => {
      const novoX =
        direcao === "direita"
          ? Math.min(estado.nave.x + 40, width - estado.nave.width)
          : Math.max(estado.nave.x - 40, 0);
      estadoGlobal.valor = { ...estado, nave: { ...estado.nave, x: novoX } };
    };

    const atualizarPontuacao = (pontos) => {
      document.getElementById("pontuacao").textContent = `Pontos: ${pontos}`;
    };

    // Event listeners
    window.addEventListener("keydown", function (e) {
      const estado = estadoGlobal.valor;
      if (!estado || !estado.ativo) return;

      if (e.key === "ArrowRight") moverNave(estado, "direita");
      if (e.key === "ArrowLeft") moverNave(estado, "esquerda");
      if (e.key === " ") atirar(estado);
    });

    document.getElementById("start-btn").addEventListener("click", iniciarJogo);
    document.getElementById("restart-btn").addEventListener("click", iniciarJogo);

    // Redimensionamento da tela
    window.addEventListener('resize', () => {
      if (estadoGlobal.valor && estadoGlobal.valor.ativo) {
        const ratioX = window.innerWidth / width;
        const ratioY = window.innerHeight / height;
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Ajusta posições dos elementos
        if (estadoGlobal.valor.nave) {
          estadoGlobal.valor.nave.x *= ratioX;
          estadoGlobal.valor.nave.y *= ratioY;
        }
        
        if (estadoGlobal.valor.rochas) {
          estadoGlobal.valor.rochas = estadoGlobal.valor.rochas.map(rocha => ({
            ...rocha,
            x: rocha.x * ratioX,
            y: rocha.y * ratioY
          }));
        }
        
        if (estadoGlobal.valor.tiros) {
          estadoGlobal.valor.tiros = estadoGlobal.valor.tiros.map(tiro => ({
            ...tiro,
            x: tiro.x * ratioX,
            y: tiro.y * ratioY
          }));
        }
      }
    });
  </script>
</body>
</html>